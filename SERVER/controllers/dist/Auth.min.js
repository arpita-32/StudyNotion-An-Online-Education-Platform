"use strict";var User=require("../models/User"),OTP=require("../models/OTP"),otpGenerator=require("otp-generator"),bcrypt=require("bcrypt"),jwt=require("jsonwebtoken");require("dotenv").config(),exports.sendOTP=function(r,s){var t,a,n,u,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.body.email,e.next=4,regeneratorRuntime.awrap(User.findOne({email:t}));case 4:if(e.sent)return e.abrupt("return",s.status(401).json({success:!1,message:"User already registered"}));e.next=7;break;case 7:return a=otpGenerator.generate(6,{upperCaseAlphabets:!1,lowerCaseAlphabets:!1,specialChars:!1}),console.log("OTP generated:",a),e.next=11,regeneratorRuntime.awrap(OTP.findOne({otp:a}));case 11:n=e.sent;case 12:if(n)return a=otpGenerator.generate(6,{upperCaseAlphabets:!1,lowerCaseAlphabets:!1,specialChars:!1}),e.next=16,regeneratorRuntime.awrap(OTP.findOne({otp:a}));e.next=19;break;case 16:n=e.sent,e.next=12;break;case 19:return u={email:t,otp:a},e.next=22,regeneratorRuntime.awrap(OTP.create(u));case 22:c=e.sent,console.log(c),s.status(200).json({success:!0,message:"otp sent successfully",otp:a}),e.next=31;break;case 27:return e.prev=27,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",s.status(500).json({success:!1,message:e.t0.message}));case 31:case"end":return e.stop()}},null,null,[[0,27]])},exports.signUp=function(r,s){var t,a,n,u,c,o,i,p,l,g,d,m;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=r.body,a=t.firstName,n=t.lastName,u=t.email,c=t.password,o=t.confirmPassword,i=t.accountType,p=t.contactNumber,l=t.otp,a&&n&&u&&c&&o&&l){e.next=4;break}return e.abrupt("return",s.status(403).json({success:!1,message:"All fields are required"}));case 4:if(c!==o)return e.abrupt("return",s.status(400).json({success:!1,message:"Password and confirmpassword value does not match,please try again"}));e.next=6;break;case 6:return e.next=8,regeneratorRuntime.awrap(User.findOne({email:u}));case 8:if(e.sent)return e.abrupt("return",s.status(400).json({success:!1,message:"User is already registered"}));e.next=11;break;case 11:return e.next=13,regeneratorRuntime.awrap(OTP.find({email:u}).sort({createdAt:-1}).limit(1));case 13:if(g=e.sent,console.log(g),0==g.length)return e.abrupt("return",s.status(400).json({success:!1,message:"otp found"}));e.next=19;break;case 19:if(l!==g.otp)return e.abrupt("return",s.status(400).json({success:!1,message:"Invalid otp"}));e.next=21;break;case 21:return e.next=23,regeneratorRuntime.awrap(bcrypt.hash(c,10));case 23:return d=e.sent,e.next=26,regeneratorRuntime.awrap(Profile.create({gender:null,dateOfBirth:null,about:null,contactNumber:null}));case 26:return m=e.sent,e.next=29,regeneratorRuntime.awrap(User.create({firstName:a,lastName:n,email:u,contactNumber:p,password:d,accountType:i,additionalDetails:m._id,image:"https://api.dicebear.com/5.x/initials/svg?seed=".concat(a," ").concat(n)}));case 29:return e.sent,e.abrupt("return",s.status(4200).json({success:!0,message:"User is registered successfully"}));case 33:return e.prev=33,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",s.status(500).json({success:!1,message:"User cannot be registered .please try again"}));case 37:case"end":return e.stop()}},null,null,[[0,33]])},exports.login=function(r,s){var t,a,n,u,c,o,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=r.body,a=t.email,n=t.password,a&&n){e.next=4;break}return e.abrupt("return",s.status(403).json({success:!1,message:"all fields are required please try again"}));case 4:return e.next=6,regeneratorRuntime.awrap(User.findOne({email:a}).populate("additionalDetails"));case 6:if(u=e.sent){e.next=9;break}return e.abrupt("return",s.status(401).json({success:!1,message:"User is not  registered .please signup first"}));case 9:return e.next=11,regeneratorRuntime.awrap(bcrypt.compare(n,u.password));case 11:if(!e.sent){e.next=20;break}c={email:u.email,id:u._id,accountType:u.accountType},o=jwt.sign(c,process.env.JWT_SECRET,{expiresIn:"2h"}),u.token=o,u.password=void 0,i={expires:new Date(Date.now()+2592e4),httpOnly:!0},s.cookie("token",o,i).status(200).json({success:!0,token:o,user:u,message:"logged in successfully"}),e.next=21;break;case 20:return e.abrupt("return",s.status(401).json({success:!1,message:"pssword is incorrect"}));case 21:e.next=27;break;case 23:return e.prev=23,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",s.status(500).json({success:!1,message:"User is not registered .please signup"}));case 27:case"end":return e.stop()}},null,null,[[0,23]])},exports.changePassword=function(){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:case 1:case"end":return e.stop()}})};
//# sourceMappingURL=Auth.min.js.map
