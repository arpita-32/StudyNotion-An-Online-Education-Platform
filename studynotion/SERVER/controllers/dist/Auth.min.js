"use strict";var bcrypt=require("bcryptjs"),User=require("../models/User"),OTP=require("../models/OTP"),jwt=require("jsonwebtoken"),otpGenerator=require("otp-generator"),mailSender=require("../utils/mailSender"),_require=require("../mail/passwordUpdate"),passwordUpdated=_require.passwordUpdated,Profile=require("../models/Profile");require("dotenv").config(),exports.signup=function(r,s){var t,a,n,u,o,c,i,l,p,d,m,g,w,b;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=r.body,a=t.firstName,n=t.lastName,u=t.email,o=t.password,c=t.confirmPassword,i=t.accountType,l=t.contactNumber,p=t.otp,a&&n&&u&&o&&c&&p){e.next=4;break}return e.abrupt("return",s.status(403).send({success:!1,message:"All Fields are required"}));case 4:if(o!==c)return e.abrupt("return",s.status(400).json({success:!1,message:"Password and Confirm Password do not match. Please try again."}));e.next=6;break;case 6:return e.next=8,regeneratorRuntime.awrap(User.findOne({email:u}));case 8:if(e.sent)return e.abrupt("return",s.status(400).json({success:!1,message:"User already exists. Please sign in to continue."}));e.next=11;break;case 11:return e.next=13,regeneratorRuntime.awrap(OTP.find({email:u}).sort({createdAt:-1}).limit(1));case 13:if(d=e.sent,console.log(d),0===d.length)return e.abrupt("return",s.status(400).json({success:!1,message:"The OTP is not valid"}));e.next=19;break;case 19:if(p!==d[0].otp)return e.abrupt("return",s.status(400).json({success:!1,message:"The OTP is not valid"}));e.next=21;break;case 21:return e.next=23,regeneratorRuntime.awrap(bcrypt.hash(o,10));case 23:return m=e.sent,g="Instructor"!==(g=""),e.next=28,regeneratorRuntime.awrap(Profile.create({gender:null,dateOfBirth:null,about:null,contactNumber:null}));case 28:return w=e.sent,e.next=31,regeneratorRuntime.awrap(User.create({firstName:a,lastName:n,email:u,contactNumber:l,password:m,accountType:i,approved:g,additionalDetails:w._id,image:""}));case 31:return b=e.sent,e.abrupt("return",s.status(200).json({success:!0,user:b,message:"User registered successfully"}));case 35:return e.prev=35,e.t0=e.catch(0),console.error(e.t0),e.abrupt("return",s.status(500).json({success:!1,message:"User cannot be registered. Please try again."}));case 39:case"end":return e.stop()}},null,null,[[0,35]])},exports.login=function(r,s){var t,a,n,u,o,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=r.body,a=t.email,n=t.password,a&&n){e.next=4;break}return e.abrupt("return",s.status(400).json({success:!1,message:"Please Fill up All the Required Fields"}));case 4:return e.next=6,regeneratorRuntime.awrap(User.findOne({email:a}).populate("additionalDetails"));case 6:if(u=e.sent){e.next=9;break}return e.abrupt("return",s.status(401).json({success:!1,message:"User is not Registered with Us Please SignUp to Continue"}));case 9:return e.next=11,regeneratorRuntime.awrap(bcrypt.compare(n,u.password));case 11:if(!e.sent){e.next=19;break}o=jwt.sign({email:u.email,id:u._id,accountType:u.accountType},process.env.JWT_SECRET,{expiresIn:"24h"}),u.token=o,u.password=void 0,c={expires:new Date(Date.now()+2592e5),httpOnly:!0},s.cookie("token",o,c).status(200).json({success:!0,token:o,user:u,message:"User Login Success"}),e.next=20;break;case 19:return e.abrupt("return",s.status(401).json({success:!1,message:"Password is incorrect"}));case 20:e.next=26;break;case 22:return e.prev=22,e.t0=e.catch(0),console.error(e.t0),e.abrupt("return",s.status(500).json({success:!1,message:"Login Failure Please Try Again"}));case 26:case"end":return e.stop()}},null,null,[[0,22]])},exports.sendotp=function(r,s){var t,a,n,u,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.body.email,e.next=4,regeneratorRuntime.awrap(User.findOne({email:t}));case 4:if(e.sent)return e.abrupt("return",s.status(401).json({success:!1,message:"User is Already Registered"}));e.next=7;break;case 7:return a=otpGenerator.generate(6,{upperCaseAlphabets:!1,lowerCaseAlphabets:!1,specialChars:!1}),e.next=10,regeneratorRuntime.awrap(OTP.findOne({otp:a}));case 10:for(n=e.sent,console.log("Result is Generate OTP Func"),console.log("OTP",a),console.log("Result",n);n;)a=otpGenerator.generate(6,{upperCaseAlphabets:!1});return u={email:t,otp:a},e.next=18,regeneratorRuntime.awrap(OTP.create(u));case 18:o=e.sent,console.log("OTP Body",o),s.status(200).json({success:!0,message:"OTP Sent Successfully",otp:a}),e.next=27;break;case 23:return e.prev=23,e.t0=e.catch(0),console.log(e.t0.message),e.abrupt("return",s.status(500).json({success:!1,error:e.t0.message}));case 27:case"end":return e.stop()}},null,null,[[0,23]])},exports.changePassword=function(r,s){var t,a,n,u,o,c,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(User.findById(r.user.id));case 3:return t=e.sent,a=r.body,n=a.oldPassword,u=a.newPassword,e.next=7,regeneratorRuntime.awrap(bcrypt.compare(n,t.password));case 7:if(e.sent){e.next=10;break}return e.abrupt("return",s.status(401).json({success:!1,message:"The password is incorrect"}));case 10:return e.next=12,regeneratorRuntime.awrap(bcrypt.hash(u,10));case 12:return o=e.sent,e.next=15,regeneratorRuntime.awrap(User.findByIdAndUpdate(r.user.id,{password:o},{new:!0}));case 15:return c=e.sent,e.prev=16,e.next=19,regeneratorRuntime.awrap(mailSender(c.email,"Password for your account has been updated",passwordUpdated(c.email,"Password updated successfully for ".concat(c.firstName," ").concat(c.lastName))));case 19:i=e.sent,console.log("Email sent successfully:",i.response),e.next=27;break;case 23:return e.prev=23,e.t0=e.catch(16),console.error("Error occurred while sending email:",e.t0),e.abrupt("return",s.status(500).json({success:!1,message:"Error occurred while sending email",error:e.t0.message}));case 27:return e.abrupt("return",s.status(200).json({success:!0,message:"Password updated successfully"}));case 30:return e.prev=30,e.t1=e.catch(0),console.error("Error occurred while updating password:",e.t1),e.abrupt("return",s.status(500).json({success:!1,message:"Error occurred while updating password",error:e.t1.message}));case 34:case"end":return e.stop()}},null,null,[[0,30],[16,23]])};
//# sourceMappingURL=Auth.min.js.map
