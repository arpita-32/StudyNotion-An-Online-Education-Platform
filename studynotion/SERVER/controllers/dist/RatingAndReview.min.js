"use strict";var RatingAndReview=require("../models/RatingAndReview"),Course=require("../models/Course"),_require=require("mongoose"),mongoose=_require.default;exports.createRating=function(r,t){var s,n,a,u,c,i,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.user.id,n=r.body,a=n.rating,u=n.review,c=n.courseId,e.next=5,regeneratorRuntime.awrap(Course.findOne({_id:c,studentsEnrolled:{$eleMatch:{$eq:s}}}));case 5:return e.sent,e.next=8,regeneratorRuntime.awrap(RatingAndReview.findOne({user:s,course:c}));case 8:if(e.sent){e.next=11;break}return e.abrupt("return",t.status(403).json({success:!1,message:"course is already reviewed by the user"}));case 11:return e.next=13,regeneratorRuntime.awrap(RatingAndReview.create({rating:a,review:u,course:c,user:s}));case 13:return i=e.sent,e.next=16,regeneratorRuntime.awrap(Course.findByIdAndUpdate({_id:c},{$push:{ratingAndReviews:i._id}},{new:!0}));case 16:return o=e.sent,console.log(o),e.abrupt("return",t.status(200).json({success:!0,message:"rating and review created successfully",ratingReview:i}));case 21:return e.prev=21,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",t.status(500).json({success:!1,message:e.t0.message}));case 25:case"end":return e.stop()}},null,null,[[0,21]])},exports.getAverageRating=function(r,t){var s,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.body.courseId,e.next=4,regeneratorRuntime.awrap(RatingAndReview.aggregate([{$match:{course:new mongoose.Types.ObjectId(s)}},{$group:{_id:null,averageRating:{$avg:"$rating"}}}]));case 4:if(0<(n=e.sent).length)return e.abrupt("return",t.status(200).json({success:!0,averageRating:n[0].averageRating}));e.next=7;break;case 7:return e.abrupt("return",t.status(200).json({success:!0,message:"Average rating is 0 ,till now",averageRating:0}));case 10:return e.prev=10,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",t.status(500).json({success:!1,message:e.t0.message}));case 14:case"end":return e.stop()}},null,null,[[0,10]])},exports.getAllRating=function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(RatingAndReview.find({}).sort({rating:"desc"}).populate({path:"user",select:"firstName lastName email image"}).populate({path:"course",select:"courseName"}).exec());case 3:return t=e.sent,e.abrupt("return",r.status(200).json({success:!0,message:"All reviews fetched successfully",data:t}));case 7:return e.prev=7,e.t0=e.catch(0),console.log(e.t0),e.abrupt("return",r.status(500).json({success:!1,message:e.t0.message}));case 11:case"end":return e.stop()}},null,null,[[0,7]])};
//# sourceMappingURL=RatingAndReview.min.js.map
